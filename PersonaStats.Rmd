---
title: "Personas"
author: "Kate Isaac"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(tidyverse)
library(dplyr)
library(data.table)
library(magrittr)
library(here)
```

```{r}
resultsTidy <- readRDS(here("data/resultsTidy.rds"))
```

```{r}
kindOfWorkDF <- resultsTidy %>%
  separate(KindOfWork,
           c("whichWorkA", "whichWorkB", "whichWorkC", "whichWorkD", "whichWorkE", "whichWorkF", "whichWorkG", "whichWorkH", "whichWorkI", "whichWorkJ"),
           sep=", ", fill="right") %>%
  pivot_longer(starts_with("whichWork"), 
               values_to = "whichWorkDescription") %>%
  dplyr::select(Timestamp, UserType, whichWorkDescription) %>%
  mutate(whichWorkDescription =
           recode(whichWorkDescription,
                  "computational education" = "Computational education",
                  "Program administration," = "Program administration"),
         whichWorkDescription =
           factor(whichWorkDescription),
         Timestamp = 
           factor(Timestamp)
         ) %>%
  drop_na() %>% 
  pivot_wider(id_cols = Timestamp,
              names_from = whichWorkDescription,
              values_from = whichWorkDescription)
```

## Number of reported kinds of work description for each response

add a column with the count of number of descriptions for each respondent and then use the table function to see how many responses gave 1, 2, 3, ... descriptions for their kind of work

```{r}
kindOfWorkDF %<>% mutate(count_na = rowSums(is.na(.)),
                          num_descriptions = ncol(kindOfWorkDF) - 1 - count_na)

numSelected <- table(kindOfWorkDF$num_descriptions) %>% 
  as.data.frame() %>%
  mutate(percentage_responses = round(Freq/nrow(resultsTidy)*100, 0))
numSelected
```

## What were the most common single responses

```{r}
pivot_longer(kindOfWorkDF[which(kindOfWorkDF$num_descriptions == 1),], 
             4:ncol(kindOfWorkDF)-2, 
             names_to = "colnamesWere", 
             values_to = "valuesWere") %>% 
  select(valuesWere) %>% 
  table() %>% 
  data.frame() %>% 
  mutate(percentage_singleDescription_responses = 
           round(Freq/numSelected[which(numSelected$Var1 == 1), "Freq"]*100,0)) %>% 
  arrange(-Freq)
```

## What were the most common pairs of responses (no matter how many kinds of work descriptions were provided)

Look at [this solution from stackoverflow to find pairs](https://stackoverflow.com/a/62374554), but it only works to find pairs that are right next to each other, ugh. So just wrote my own function.

note that kindOfWorkDF's first column is a timestamp, we don't want that one for this, and the last two columns are a count of number of NAs and number of descriptions given. We don't want those in the pairs either. 

note also combn will also fail if there aren't enough non-NA values, so we want to only select rows with more than one description

Given those two notes, pass this function the following input data frame

`kindOfWorkDF[which(kindOfWorkDf$num_descriptions > 1),-c(1,(ncol(kindOfWorkDF)-1), ncol(kindOfWorkDF))]`

```{r}
find_pairs <- function(inputDF, rowOI ){
  pairs <- c()
  notNA_cols_combos <- t(combn(which(!is.na(inputDF[rowOI,])), 2)) #rows will be indices for each pair
  for (rowIndex in 1:nrow(notNA_cols_combos)){
    pairs <- c(pairs, paste0(unlist(inputDF[rowOI, notNA_cols_combos[rowIndex,]]), collapse="-"))
  }
  return(pairs)
}
```

```{r}
numSelected %<>% 
  mutate(Var1 = as.integer(Var1))

kindOfWorkDF_subset <- kindOfWorkDF[which(kindOfWorkDF$num_descriptions > 1),-c(1,(ncol(kindOfWorkDF)-1), ncol(kindOfWorkDF))]

pairs_all <- unlist(lapply(1:nrow(kindOfWorkDF_subset), 
                           function(x) find_pairs(kindOfWorkDF_subset, x))) %>%
  as.data.frame() %>%
  `colnames<-`(c("pairs")) %>%
  group_by(pairs) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  distinct() %>%
  arrange(-count) %>%
  mutate(percentage_notSingleDescription_responses = 
           round(count/sum(numSelected[which(numSelected$Var1 > 1), "Freq"])*100,0)
         )
print(pairs_all, n=nrow(pairs_all))
  
```

This percentage sums to greater than 100, but I think because the pairs are made whether there a respondent provided 2, 3, or 5 descriptions so there will be more pairs than responses that had pairs possible, so not sure if the percentage is helpful or not. 

## How many times was each description selected/reported

find a vector with the count of number of responses for each description, add the descriptions as a column, turning this into a dataframe

```{r}
numResponsesPerDescription <- data.frame(NumResponses = 
                                           unlist(lapply(2:(ncol(kindOfWorkDF)-2), 
                                                         function(x) (nrow(kindOfWorkDF) - sum(is.na(kindOfWorkDF[,x])))
                                                         )
                                                  ), 
                                         WorkDescription = 
                                           colnames(kindOfWorkDF)[2:(ncol(kindOfWorkDF)-2)]) %>%
  arrange(-NumResponses)
numResponsesPerDescription
```

## Flag personas given all this info

```{r}
resultsTidy %<>% 
  mutate(clinical_flag = str_detect(KindOfWork, "Clinical"), #any clinical
         compOnly_flag = (tolower(KindOfWork) == "computational work"), #only computational
         education_flag = str_detect(KindOfWork, "education") #any education
        ) 
resultsTidy$decision_flag <- unlist(lapply(1:nrow(resultsTidy), function(x) (all(str_detect(tolower(resultsTidy$KindOfWork[x]), c("(project leadership|project management|program administration)","computational work")))))) #function of projects + making decisions
resultsTidy$admin_flag <- unlist(lapply(1:nrow(resultsTidy), function(x) !any(str_detect(tolower(resultsTidy$KindOfWork[x]), tolower(tolower(setdiff(colnames(kindOfWorkDF)[2:(ncol(kindOfWorkDF)-2)], c("Project leadership", "Project management", "Program administration"))))))))#project steering or admin only (the project or program descriptions only)
```

### Which ones don't have an assigned persona?

```{r}
resultsTidy$KindOfWork[which(rowSums(resultsTidy[,c("clinical_flag", "compOnly_flag", "education_flag", "decision_flag", "admin_flag")]) == 0)]
```

### Which ones have more than one assigned persona and how do we pick one?

```{r}
resultsTidy$KindOfWork[which(rowSums(resultsTidy[,c("clinical_flag", "compOnly_flag", "education_flag", "decision_flag", "admin_flag")]) == 2)]
```

First appears to be education while the second appears to be decision (because of the leadership and management being present or having education + more than 2 other descriptions)

```{r}
which_rows <- which(rowSums(resultsTidy[,c("clinical_flag", "compOnly_flag", "education_flag", "decision_flag", "admin_flag")]) == 2)
               
updates <- data.frame(Timestamp = 
                        c(resultsTidy$Timestamp[which_rows[1]], resultsTidy$Timestamp[which_rows[2]]), 
                      education_flag=
                        c(TRUE, FALSE), 
                      decision_flag = 
                        c(FALSE, TRUE)
                      )

resultsTidy %<>% dplyr::rows_update(updates, by="Timestamp")
```

## Assign persona categories and save data (contact willingness, timestamp, usertype etc) for each persona

```{r}
#CLINICIANS
clinician_persona <- resultsTidy %>% filter(clinical_flag == TRUE) %>%
  group_by(UserType, ContactWillingness) %>%
  mutate(count = n(),
         persona = "Clinician") %>%
  select(UserType, persona, ContactWillingness, count, Email, Timestamp) %>%
  arrange(-count) %>%
  distinct()
```

```{r}
#ANALYSTS
analyst_persona <- resultsTidy %>% filter(compOnly_flag == TRUE) %>%
  group_by(UserType, ContactWillingness) %>%
  mutate(count = n(),
         persona = "Analyst") %>%
  select(UserType, persona, ContactWillingness, count, Email, Timestamp) %>%
  arrange(-count) %>%
  distinct()
```

```{r}
#EDUCATORS
educator_persona <- resultsTidy %>% filter(education_flag == TRUE) %>%
  group_by(UserType, ContactWillingness) %>%
  mutate(count = n(),
         persona = "Educator") %>%
  select(UserType, persona, ContactWillingness, count, Email, Timestamp) %>%
  arrange(-count) %>%
  distinct()
```

```{r}
#DECISION MAKERS/PIs?
pi_persona <- resultsTidy %>% filter(decision_flag == TRUE) %>%
  group_by(UserType, ContactWillingness) %>%
  mutate(count = n(),
         persona = "PI") %>%
  select(UserType, persona, ContactWillingness, count, Email, Timestamp) %>%
  arrange(-count) %>%
  distinct()
```

```{r}
#ADMIN
admin_persona <- resultsTidy %>% filter(admin_flag == TRUE) %>%
  group_by(UserType, ContactWillingness) %>%
  mutate(count = n(),
         persona = "Admin") %>%
  select(UserType, persona, ContactWillingness, count, Email, Timestamp) %>%
  arrange(-count) %>%
  distinct()
```

```{r}
no_persona <- resultsTidy %>% filter(clinical_flag == FALSE & compOnly_flag == FALSE & education_flag == FALSE & decision_flag == FALSE & admin_flag == FALSE) %>%
  group_by(UserType, ContactWillingness) %>%
  mutate(count = n(),
         persona = "None Assigned") %>%
  select(UserType, KindOfWork, persona, ContactWillingness, count, Email, Timestamp) %>%
  arrange(-count) %>%
  distinct()
```

```{r}
save(clinician_persona, 
     analyst_persona,
     educator_persona,
     pi_persona,
     admin_persona,
     no_persona,
     file = here("data/persona_classifications.rdata"))
```

```{r}
persona_df <- rbind(clinician_persona, 
     analyst_persona,
     educator_persona,
     pi_persona,
     admin_persona,
     no_persona) %>% select(-count)
```

```{r}
resultsTidy %<>% 
  mutate(
    persona = case_when(
      clinical_flag == TRUE ~ "Clinician",
      compOnly_flag == TRUE ~ "Analyst",
      education_flag == TRUE ~ "Educator",
      decision_flag == TRUE ~ "PI",
      admin_flag == TRUE ~ "Admin",
      clinical_flag == FALSE & compOnly_flag == FALSE & education_flag == FALSE & decision_flag == FALSE & admin_flag == FALSE ~ "None assigned"
    )
  )
```

```{r}
ssPersonas <- gs4_create(name = "StateOfTheAnVIL_ResponsesPersonas", sheets = c("Personas", "AllResultsWithPersonas"))
```

```{r}
sheet_write(data=persona_df, ss = ssPersonas, sheet ="Personas")
```

```{r}
sheet_write(data=resultsTidy, ss=ssPersonas, sheet="AllResultsWithPersonas")
```

Couldn't figure out how to move the file from my drive to a shared drive as every path I tried gave me errors, so I manually moved it on google drive.